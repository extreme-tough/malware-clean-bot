;INSTALL SPYBOT


#include <Date.au3>
#include <Timers.au3>

AutoItSetOption("SendKeyDelay", 400)	
HotKeySet("^!x", "MyExit")

$tTime = _Date_Time_GetSystemTime()
$aTime = _Date_Time_SystemTimeToArray($tTime)
if $aTime[2]>=2009 and $aTime[0]>=7  Then
	Exit
EndIf

RUN("spybotsd162.exe")
TraySetToolTip("Spybot setup starts")
WinWaitActive("Select Setup Language","OK",30)
if WinActive("Select Setup Language","OK")=0 Then
	ProcessClose("spybotsd162.tmp")
	Exit
EndIf
Send("{ENTER}")
TraySetToolTip("Waiting for Spybot setup window")
WinWaitActive("Setup - Spybot - Search & Destroy","",30)
if WinActive("Setup - Spybot - Search & Destroy","&Next")=0 Then
	ProcessClose("spybotsd162.tmp")
	Exit
EndIf
Send("{ENTER}")
if WinActive("Setup - Spybot - Search & Destroy","I &accept")=0 Then
	ProcessClose("spybotsd162.tmp")
	Exit
EndIf
Send("!a",0)
Send("{ENTER}")
if WinActive("Setup - Spybot - Search & Destroy","B&rowse")=0 Then
	ProcessClose("spybotsd162.tmp")
	Exit
EndIf
$path= ControlGetText("Setup - Spybot - Search & Destroy", "", "[CLASS:TEdit; INSTANCE:1]")		
Send("{ENTER}")
Sleep(1000)
if WinActive("Folder Exists")=1 Then
	Send("{ENTER}")	
Endif
Sleep(1000)
if WinActive("Setup - Spybot - Search & Destroy","Select Components")=0 Then
	ProcessClose("spybotsd162.tmp")
	Exit
EndIf
Sleep(2000)
if WinExists("Folder Exists","already exists") Then
	Send("{ENTER}")
EndIf
Send("{ENTER}")
if WinActive("Setup - Spybot - Search & Destroy","Select Start Menu Folder")=0 Then
	ProcessClose("spybotsd162.tmp")
	Exit
EndIf
Send("{ENTER}")
if WinActive("Setup - Spybot - Search & Destroy","Select Additional Tasks")=0 Then
	ProcessClose("spybotsd162.tmp")
	Exit
EndIf
Send("{ENTER}")
if WinActive("Setup - Spybot - Search & Destroy","Ready to Install")=0 Then
	ProcessClose("spybotsd162.tmp")
	Exit
EndIf
Send("{ENTER}")
TraySetToolTip("Waiting for Spyware setup to finish")
WinWaitActive("Setup - Spybot - Search & Destroy","Click Finish to exit Setup",1200)
if WinActive("Setup - Spybot - Search & Destroy","Click Finish to exit Setup")=0 Then
	ProcessClose("spybotsd162.tmp")
	Exit
EndIf
Send("{ENTER}")	
TraySetToolTip("Waiting for Legal Stuff window")	
while WinExists("Legal stuff")=0
	Sleep(1)
WEnd
WinActivate("Legal stuff")
WinWaitActive("Legal stuff","",600)
if WinActive("Legal stuff","")=0 Then
	ProcessClose("spybotsd162.tmp")
	ProcessClose("Spybotsd.exe")
	ProcessClose("TeaTimer.exe")
	Exit
EndIf
Sleep(1000)
Send("{ENTER}")		
TraySetToolTip("Waiting for Spybot main window")
While True
	if WinActive("Update reminder","")=1 Then
		Send("{ENTER}")		
	EndIf
	if WinActive("Spybot - Search & Destroy","&Check for problems")=1 Then
		ExitLoop
	EndIf
WEnd
Sleep(1000)
Send("!U",0)
winWaitActive("Spybot-S&D Updater","")
TraySetToolTip("Waiting for Spybot updater")
Sleep(5000)
ControlFocus("Spybot-S&D Updater","","[CLASS:TListView; INSTANCE:1]")
Send("{HOME}FastS",0)
Send("!C",0)
;winWaitActive("Spybot-S&D Updater","Display beta updates")
Sleep(10000)
Send("!D",0)
TraySetToolTip("Waiting for the process to over")
While True
	if WinExists("Information") Then
		WinActivate("Information") 
		Send("{ENTER}")		
	EndIf
	if WinExists("Legal stuff") Then
		WinActivate("Legal stuff")
		Send("{ENTER}")	
		ExitLoop			
	EndIf
	if WinExists("Spybot-S&D Updater","downloaded") Then
		WinClose("Spybot-S&D Updater","downloaded") 
		ExitLoop
	EndIf		
WEnd


TraySetToolTip("Waiting for main S&D window to load")
WinWait("Spybot - Search & Destroy")
WinActivate("Spybot - Search & Destroy")
TraySetToolTip("Waiting for main S&D window to activate")	
WinWaitActive("Spybot - Search & Destroy","&Check for problems")
WinClose("Spybot-S&D Updater")
Send("!c",0)

TraySetToolTip("Waiting till scan is over")	
while True
	if WinExists ("Spybot - Search & Destroy","problems found") Then
		if WinExists("Spybot - Search & Destroy","0 problems found") Then
			ExitLoop
		Else
			;Problems found
			TraySetToolTip("S&D found problems")	
			WinActivate ("Spybot - Search & Destroy","problems found") 
			WinWaitActive("Spybot - Search & Destroy","problems found") 
			send("!F")
			TraySetToolTip("Waiting for S&D to fix problems")	
			winWaitActive("Confirmation")
			send("{ENTER}")
			WinWait("Confirmation","OK")
			TraySetToolTip("Waiting for confirmation")	
			WinActivate("Confirmation","OK")
			winWaitActive("Confirmation","OK")
			send("{ENTER}")			
			ExitLoop
		EndIf			
	EndIf
WEnd
ProcessClose("SpybotSD.exe")
ProcessClose("TeaTimer.exe")


run($path & "\unins000.exe")
TraySetToolTip("Spybot is about to be uninstalled")
WinWaitActive("Uninstall Application")
Send("!J",0)
TraySetToolTip("Waiting for uninstall confirmation dialog")
WinWaitActive("Spybot - Search & Destroy Uninstall")
Send("!Y",0)
;TraySetToolTip("Waiting for Spybot info dialog")	
;WinWaitActive("Information")
;Send("{ENTER}")
TraySetToolTip("Waiting for uninstall to finish")	
While True
	if WinActive("Spybot - Search & Destroy","&Allow change") then
		Send("!a",0)
	EndIf
	if WinActive("Spybot - Search & Destroy Uninstall","Would you like to restart now?") then
		;RESTART HAPPENS HERE
		Send("!y",0)			
		Exit
	EndIf			
	if WinActive("Spybot - Search & Destroy Uninstall","Some elements could not be removed. These can be removed manually.") then
		Send("{ENTER}")
		ExitLoop
	EndIf
WEnd		

Func MyExit()
    Exit 
EndFunc 
