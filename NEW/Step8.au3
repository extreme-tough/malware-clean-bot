AutoItSetOption("SendKeyDelay", 400)
Run("sdstart.exe")
TraySetToolTip("Waiting for app start")
WinWaitActive("Setup - Spyware Doctor","&Next",30)
if WinActive("Setup - Spyware Doctor","&Next")=0 Then
	ProcessClose("sdstart.exe")
	ProcessClose("sdstart.tmp")
	Exit
EndIf
Send("!n")
TraySetToolTip("Waiting for agreement dialog")
WinWaitActive("Setup - Spyware Doctor","I &accept",5)
if WinActive("Setup - Spyware Doctor","I &accept")=0 Then
	ProcessClose("sdstart.exe")
	ProcessClose("sdstart.tmp")
	Exit
EndIf
Send("!a")
Send("!n")
TraySetToolTip("Waiting for Destination location")
WinWaitActive("Setup - Spyware Doctor","Select Destination Location",5)
if WinActive("Setup - Spyware Doctor","Select Destination Location")=0 Then
	ProcessClose("sdstart.exe")
	ProcessClose("sdstart.tmp")
	Exit
EndIf
$path = ControlGetText("Setup - Spyware Doctor","Select Destination Location","[CLASS:TEdit; INSTANCE:1]")
Send("!n")
;TODO Confiramtion dialog handle
TraySetToolTip("Waiting for additional tasks")
WinWaitActive("Setup - Spyware Doctor","Select Additional Tasks",3)
if WinActive("Folder Exists","")=1 Then
	Send ("{ENTER}")
	WinWaitActive("Setup - Spyware Doctor","Select Additional Tasks",3)	
EndIf
if WinActive("Setup - Spyware Doctor","Select Additional Tasks")=0 Then
	ProcessClose("sdstart.exe")
	ProcessClose("sdstart.tmp")
	Exit
EndIf
Send("!d")
Send("!i")
TraySetToolTip("Waiting for finish dialog")
WinWaitActive("Setup - Spyware Doctor","&Finish",300)
if WinActive("Setup - Spyware Doctor","&Finish")=0 Then
	;Download in progress.
	if WinActive("Setup - Spyware Doctor","Elapsed Time")=1 Then
		;Download still in progress. Wait again
		TraySetToolTip("Waiting for download to be over")
		WinWaitActive("Setup - Spyware Doctor","&Finish",600)
	EndIf
	if WinActive("Setup - Spyware Doctor","&Finish")=1 Then
	Else
		ProcessClose("sdstart.exe")
		ProcessClose("sdstart.tmp")
		ProcessClose("udpate.exe")
		Exit
	EndIf
EndIf
Send("!f")

;New Code
Sleep(6000)
if WinActive("Spyware Doctor","Start Scan")=1 Then
	;Window is already active and scan started
Else
	;Start Smart updations
	TraySetToolTip("Waiting for Smart update query")
	WinWaitActive("Spyware Doctor - Updates Require","Run Smart Update",180)
	if WinActive("Spyware Doctor - Updates Require","Run Smart Update")=0 Then
		ProcessClose("update.exe")
		Exit
	EndIf
	ControlClick("Spyware Doctor - Updates Require","Run Smart Update","[CLASS:TButton; INSTANCE:2]")


	TraySetToolTip("Waiting for Smart update starter")
	;TODO Handle updations
	WinWaitActive("Smart Update","&Next",120)
	if WinActive("Smart Update","&Next")=0 Then
		ProcessClose("update.exe")
		Exit
	EndIf
	Send("!n")

	TraySetToolTip("Waiting for Smart update to finish")
	;TODO Handle updations
	WinWaitActive("Smart Update","&Finish",120)
	if WinActive("Smart Update","&Finish")=0 Then
		ProcessClose("update.exe")
		Exit
	EndIf
	Send("!f")
EndIf


TraySetToolTip("Waiting for SPYDOC to finish scanning")
while True
	if WinExists("Spyware Doctor","Fix Checked") Then
		TraySetToolTip("Infections found by SPYDOC")
		WinActivate("Spyware Doctor","Fix Checked") 
		WinWaitActive("Spyware Doctor","Fix Checked") 
		ControlClick("Spyware Doctor","","[CLASS:TBitBtn; INSTANCE:1]")
		TraySetToolTip("Waiting for fix and legal notice")		
		WinWaitActive("Legal Notice")
		ControlClick("Legal Notice","","[CLASS:TButton; INSTANCE:2]")
		TraySetToolTip("Waiting for completion of fixing")
		WinWaitActive("Spyware Doctor","Finish")
		ExitLoop
	ElseIf WinExists("Spyware Doctor","Finish") then
		TraySetToolTip("No Infections found by SPYDOC")
		WinActivate("Spyware Doctor","Finish")
		WinWaitActive("Spyware Doctor","Finish")
		ExitLoop
	EndIf
WEnd
WinClose("Spyware Doctor")
processClose("pctsGui.exe")
processClose("pctsTray.exe")

;TODO
run($path & "\unins000.exe")
TraySetToolTip("Waiting SPYDOC uninstall to start")
WinWaitActive("Spyware Doctor Uninstall","Are you sure you")
send("!Y",0)
TraySetToolTip("Waiting SPYDOC uninstall to finish")
WinWaitActive("Spyware Doctor Uninstall","Would you like to restart now")
send("!N",0)
WinWaitClose("Spyware Doctor Uninstall","Would you like to restart now")
