

$os=@OSVersion
if $os="WIN_VISTA" Then		
	run(@SystemDir  & "\DFRgui.exe")
	TraySetToolTip("Waiting for degfrag window")
	WinWaitActive("Disk Defragmenter")
	if ControlGetText("Disk Defragmenter","","[CLASS:Button; INSTANCE:6]")	= "Defragment &now" Then		
		ControlClick("Disk Defragmenter","","[CLASS:Button; INSTANCE:6]")	
	EndIf
	TraySetToolTip("Waiting for degfrag to finish")
	WinWaitActive("Disk Defragmenter","Defragment now")
	WinClose("Disk Defragmenter")
EndIf

if $os="WIN_XP" Then
	ShellExecute (@SystemDir  &  "\dfrg.msc")
	TraySetToolTip("Waiting for degfrag window")
	WinWaitActive("Disk Defragmenter")
	ControlClick("Disk Defragmenter","","[CLASS:Button; INSTANCE:1]")
	WinWaitNotActive("Disk Defragmenter","Analyze")
	if WinActive("Disk Defragmenter","You should defragment this volume")=1 Then
		ControlClick("[ACTIVE]","","[CLASS:Button; INSTANCE:4]")		
		TraySetToolTip("Waiting for degfrag to finish")
		WinWaitNotActive("Disk Defragmenter","Analyze")
		if WinActive ("Disk Defragmenter","Defragmentation is complete")=1 Then
			ControlClick("Disk Defragmenter","","[CLASS:Button; INSTANCE:5]")
		Else
			if WinActive("Disk Defragmenter","now anyway?") = 1 Then
				Send("!n")
			EndIf
		EndIf
		WinClose("Disk Defragmenter")
	EndIf
	if WinActive("Disk Defragmenter","You do not need to defragment this volume")=1 Then
		ControlClick("Disk Defragmenter","","[CLASS:Button; INSTANCE:5]")
		WinClose("Disk Defragmenter")
	EndIf
EndIf

run("chkdsk /f")
TraySetToolTip("Waiting for console")
WinWaitActive("[CLASS:ConsoleWindowClass]")
TraySetToolTip("sleeping for 2 sec")
Sleep(2000)
Send("Y{ENTER}")

RegDelete("HKEY_CURRENT_USER\SOFTWARE\AutoTool")
RegDelete("HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run", "Rerun")

WinActivate("Configuration Wizard","&Restart Computer")
Send("!r")

Func MyExit()
    Exit 
EndFunc 

